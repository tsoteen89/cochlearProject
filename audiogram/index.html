<!DOCTYPE html>
<html lang="en">
  <head>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
    <link rel="stylesheet" href="css/context.bootstrap.css">
    <link rel="stylesheet" href="css/chosen.css">   
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/kinetic-v5.0.2.min.js"></script>
<!--      http://www.bootstraptoggle.com/-->
    <!-- <link href="./css/bootstrap-toggle.css" rel="stylesheet">-->
    <!-- <script src="./js/bootstrap-toggle.js"></script>-->
    <script src="js/context.js"></script> 
    <script src="js/contextMenu.js"></script>
    <script src="js/chosen.jquery.js"></script> 
    <script src="js/audiogram.js"></script>  
    <style>
        /* scheme 1 */
        /* turquiose #64D4F9 */
        /* robins egg #15C2D2 */
        /* orange yellow #F7C868 */
        /* light carmine pink #F16767 */
        /* mamba #776A7D */
        
        /* scheme 2 */
        /*dark cyan #008D8E*/
        /*robins egg blue #15C8D1*/
        /*gray #808281*/
        /*white lilac #E5E7E6*/
        
        /* tin #7E7E7E */
        /* gray #818181 */
        
        h2 {
            color:#414141;
            text-shadow: 2px 2px #808281;
        }

        .container{
            background-color: #E5E7E6;
        }
        
        .mea-btn {
            background-color:#383D44;
            color:white;
            line-height: .9;
        }
        

        .mea-btn:hover{
            color:#7E7E7E;            
        }
    /*Audiograph action/menu buttons*/  
        .audiogram-menu{
            margin-bottom: 20px;
            margin-top:-20px;
            padding-left: 130px;
        }
        .btn-action{
            background-color:#383D44;
            color:white;
            padding: 3px 8px 3px 8px;
        }
        
        .btn-action:hover{
            color:#7E7E7E;
        }
        
        .btn-action .fa{
            padding-right:5px
        }

        i.fa.pull-left{
            padding-top:2px;
            padding-left:5px
        }
    /*Audiogram container styles*/            

        #audiogram_left {
            margin-left: -30px;
        }
    /*Measure buttons*/
        .btn.mea-btn {
            padding: 5px 0px 5px 0px;
        }
        .mea-btn {
          background-color: hsl(216, 9%, 21%) !important;
          background-repeat: repeat-x;
          filter: progid:DXImageTransform.Microsoft.gradient(startColorstr="#3a3e45", endColorstr="#30343a");
          background-image: -khtml-gradient(linear, left top, left bottom, from(#3a3e45), to(#30343a));
          background-image: -moz-linear-gradient(top, #3a3e45, #30343a);
          background-image: -ms-linear-gradient(top, #3a3e45, #30343a);
          background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #3a3e45), color-stop(100%, #30343a));
          background-image: -webkit-linear-gradient(top, #3a3e45, #30343a);
          background-image: -o-linear-gradient(top, #3a3e45, #30343a);
          background-image: linear-gradient(#3a3e45, #30343a);
          border-color: #30343a #30343a hsl(216, 9%, 20%);
          color: #fff !important;
          text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.06);
          -webkit-font-smoothing: antialiased;
          width:100%;
          border: 3px solid transparent;
        }
        
        .btn-toolbar{
            width:120px;
            padding:5px;
        }
        
        .border{
            border-color: #15C2D2 #15C2D2 HSL(185, 82%, 45%);
            font-weight:bold;
        }
        
        #measure-buttons{
            padding-left: 30px;
            padding-top: 100px;
        }
        
        #measure-buttons .fa{
            color:#15C8D1;
            font-size:24px;
        }        
        
        .left, .right{
            color:#15C8D1;
            font-size:24px;  
        }
        
        .left{
            padding-right:10px
        }
        
        .right{
            padding-left:10px
        }
        
        span.mid{
            color:white;
        }
        
        #mask-button{
            margin-top:30px;
            border-radius:5px;
            border-width: 2px;
        }
        
        #mask-button .fa{
            font-size:18px;
        }
        
        #mask-button a{
            color:white
        }
        
        #mask-button a:hover{
            text-decoration: none;
        }
        /*bad programming*/
        
        #no-response-button .fa{
            font-size:18px;
        }
        
        #no-response-button a{
            color:white
        }
        
        #no-response-button a:hover{
            text-decoration: none;
        }
        .btn.mea-btn a"{
            padding:0px;
            margin:0px;
        }

    /*title row*/
        .title{
            text-align:center;
            padding:0px;
            margin-top:-10px;
            margin-bottom:-40px;
        }

    .tool{
        padding: 2px 5px 2px 5px;
        margin-top: -25px;
        margin-bottom: 10px;
        width:75px;
    }
    .testButton {
        width: 80px;
        height: 80px;
        background: #3382c0;
        color: #FFF;
    }
    .audioInputs{
        width:50px;
    }
    .audioInputs-container{
        width:350px;
    }
    .audioInputs-heading{
        text-align:center;
        font-weight:bold;
    }
    .audioInputs-rowLabel{
        text-align:right;
    }
    .audioInputs-table tr {
       line-height: 10px;
       min-height: 10px;
       height: 10px;
    }
    .audioInputs-table th{
        text-align:center;
    }
    .audioInputs-table td{
        text-align:center;
    }
    .navbar-xs { min-height:22px; border-radius:0} 
    .navbar-xs .navbar-brand{ padding: 5px 8px;font-size: 24px;line-height: 14px; } 
    .navbar-xs .navbar-nav > li > a { border-right:1px solid #ddd; padding-top: 2px; padding-bottom: 2px; line-height: 16px }
    
    .button-checkbox{
        padding-left: 40px;  
    }
        
    .button-checkbox .fa{
        font-size:18px;
        color:#15C2D2;
    }
        
    .btn-masked{
          background-color: hsl(216, 9%, 21%) !important;
          background-repeat: repeat-x;
          filter: progid:DXImageTransform.Microsoft.gradient(startColorstr="#3a3e45", endColorstr="#30343a");
          background-image: -khtml-gradient(linear, left top, left bottom, from(#3a3e45), to(#30343a));
          background-image: -moz-linear-gradient(top, #3a3e45, #30343a);
          background-image: -ms-linear-gradient(top, #3a3e45, #30343a);
          background-image: -webkit-gradient(linear, left top, left bottom, color-stop(0%, #3a3e45), color-stop(100%, #30343a));
          background-image: -webkit-linear-gradient(top, #3a3e45, #30343a);
          background-image: -o-linear-gradient(top, #3a3e45, #30343a);
          background-image: linear-gradient(#3a3e45, #30343a);
          border-color: #30343a #30343a hsl(216, 9%, 20%);
          color: #fff !important;
          text-shadow: 0 -1px 0 rgba(0, 0, 0, 0.06);
          -webkit-font-smoothing: antialiased;
          border: 2px solid transparent;        
    }
    .btn-masked.btn-default{
        color: #ffffff; 
        background-color: #040008; 
        border-color: #15C2D2;   
    }
        
    </style>
  </head>
  <body>
    <div class="container">
        <div class="row">
            <nav class="navbar navbar-default navbar-xs" role="navigation">
          <!-- Brand and toggle get grouped for better mobile display -->
          <div class="navbar-header">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
              <span class="sr-only">Toggle navigation</span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="#"><b>Aii</b> Audiogram</a>
          </div>

          <!-- Collect the nav links, forms, and other content for toggling -->
          <div class="collapse navbar-collapse pull-right" id="bs-example-navbar-collapse-1">
            <ul class="nav navbar-nav">
              <li><a href="#" id="searchAudiogram"><i class="fa fa-search"></i></a></li>
              <li><a href="#" id="saveAudiogram"><i class="fa fa-save"></i></a></li>
              <li><a href="#" id="printAudiogram"><i class="fa fa-print"></i></a></li>
              <li class="dropdown">
                <a href="#" class="dropdown-toggle" data-toggle="dropdown"><b class="caret"></b></a>
                <ul class="dropdown-menu">
                  <li><a href="#"><i class="fa fa-search"></i> Search Audiogram</a></li>
                  <li><a href="#"><i class="fa fa-save"></i> Save Audiogram</a></li>
                  <li><a href="#"><i class="fa fa-print"></i> Print Audiogram</a></li>
                  <li class="divider"></li>
                  <li><a href="#">Separated link</a></li>
                  <li class="divider"></li>
                  <li><a href="#">One more separated link</a></li>
                </ul>
              </li>
            </ul>
          </div><!-- /.navbar-collapse -->
        </nav>
        </div>
        <div class="row">
            <div class="col-md-12" style="padding-top:0px">
                <div class="container-fluid well span6" style="padding:0px 0px 0px 5px;margins:5px 0px 0px 0px">
                    <div class="row-fluid">
                        <div class="col-xs-6">
                           <label class="item item-input"  style="font-size:18px"> <span class="input-label" style="font-size:20px">Patient: </span> John Smith</label>
                            <label class="item item-input" style="font-size:14px"> <span class="input-label" style="font-size:14px">Date of Birth: </span> 10 Oct 1950 </label>
 
                        </div>
                        <div class="col-xs-6">
                            <label class="item item-input"> <span class="input-label" style="font-size:16px">Title: </span> 
                                <select name="audiogramTitle" data-placeholder="Choose an Audiogram Title..." class="chosen-select-deselect" id="audiogramTitleID">
                                    <option value=""></option>
                                    <option>Pre Operative Audiogram</option>
                                    <option>Aided Testing</option>
                                    <option>Residual Hearing</option>                                    
                                </select>
                            </label>
                            <label class="item item-input"> <span class="input-label" style="font-size:16px">Date: </span> <input type="date"></label>
                        </div>
                    </div>
                </div>
            </div>           
        </div>
        <div class="row">
            <div class="col-xs-5 title">
                <h2>Right Ear</h2>
            </div>
            <div class="col-xs-2">
            </div>
            <div class="col-xs-5 title">            
                <h2>Left Ear</h2>
            </div>
        </div>
        <div class="row">
        <div class="col-xs-5"  id="left_column">
            <div id="audiogram_right"></div>
        </div>
        <div class="col-xs-2">
            <!-- Auditory measure buttons -->
            <div class="btn-group-vertical" id="measure-buttons" >
                <div class="btn-toolbar">
                    <button type="button" class="btn mea-btn border" id="AC">
                        <a href="#"><span class="left" id="ACR"><i class="fa fa-circle-o"></i></span><span class="mid">&nbsp;AC&nbsp;</span><span class="right" id="ACL">&#10005;</span></a>
                    </button>
                </div>
                <div class="btn-toolbar">
                    <button type="button" class="btn  mea-btn" id="BC">
                        <a href="#" ><span class="left" id="BCR"><i class="fa fa-chevron-left"></i>&nbsp;</span><span class="mid">&nbsp;BC&nbsp;</span><span class="right" id="BCL">&nbsp;<i class="fa fa-chevron-right"></i></span></a>
                    </button>
                </div>
                <div class="btn-toolbar">
                    <button type="button" class="btn mea-btn" id="MCL">
                        <a href="#" ><span class="left">M</span><span class="mid">MCL</span><span class="right">M</span></a>
                    </button>
                </div>
                <div class="btn-toolbar">
                    <button type="button" class="btn mea-btn" id="UCL">
                        <a href="#"><span class="left">m</span><span class="mid">UCL</span><span class="right">m</span></a>
                    </button>
                </div>
                <div class="btn-toolbar">
                    <button type="button" class="btn mea-btn" id="SF">
                        <a href="#"><span class="left">S</span><span class="mid">&nbsp;&nbsp;SF&nbsp;&nbsp;</span><span class="right">S</span></a>
                    </button>
                </div>
                <div class="btn-toolbar">
                    <button type="button" class="btn mea-btn" id="SF-A">
                        <a href="#"><span class="left">A</span><span class="mid">SF-A</span><span class="right">A</span></a>
                    </button>
                 </div>
                <br>
<!--
                <div class="btn-toolbar">
                    <button type="button" class="btn btn-default tool">
                        <img src="images/masked_volume_off.svg" width="20" id="mask-tool-svg"><br>
                        <span>Masked</span>
                    </button>
                </div>
-->
            </div>
            <div>
                <span class="button-checkbox">
                    <button type="button" class="btn btn-masked" id="mask-tool"> Masked</button>
                    <input type="checkbox" class="hidden" checked />
                </span>
            </div>

<!--
		<div class="col-xs-2 col-xs-offset-2">
			<div class="input-group number-spinner">
				<span class="input-group-btn">
					<button class="btn btn-default" data-dir="dwn"><span class="glyphicon glyphicon-minus"></span></button>
				</span>
				<input type="text" class="form-control text-center" value="ACL">
				<span class="input-group-btn">
					<button class="btn btn-default" data-dir="up"><span class="glyphicon glyphicon-plus"></span></button>
				</span>
			</div>
		</div>
-->
        </div><!-- End Button Column-->
        <div class="col-md-5" id="right_column">
            <div id="audiogram_left"></div>
        </div>
        </div> <!-- End Row -->
        <div class="row">
            <div class="col-xs-4" style="text-align:center">
                <div class="audiogram-menu" data="right">
                    <button class="btn btn-xs btn-action" data="Undo" id="undo"><i class="fa fa-undo pull-left"></i>Undo</button>
                    <button class="btn btn-xs btn-action" data="Refresh" id="refresh"><i class="fa fa-refresh pull-left"></i>Clear</button>
                    <button class="btn btn-xs btn-action" data="Redo" id="redo"><i class="fa fa-repeat pull-left"></i>Redo</button>
                </div>
            </div>
            <div class="col-xs-4" style="text-align:center">

            </div>
            <div class="col-xs-4" style="text-align:center">            
                <div class="audiogram-menu" data="left" style="margin-left:0px;padding-left:0px;">
                    <button class="btn btn-xs btn-action" data="Undo" id="undo"><i class="fa fa-undo pull-left"></i>Undo</button>
                    <button class="btn btn-xs btn-action" data="Refresh" id="refresh"><i class="fa fa-refresh pull-left"></i>Clear</button>
                    <button class="btn btn-xs btn-action" data="Redo" id="redo"><i class="fa fa-repeat pull-left"></i>Redo</button>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-xs-2"></div>
            <div class="col-xs-4">
                <div class="panel panel-default audioInputs-container">
                  <!-- Default panel contents -->
                  <div class="panel-heading audioInputs-heading">Speech Audiometry</div>

                  <!-- Table -->
                  <table class="table audioInputs-table">
                     <tr style="text-align:center"><th></th><th>SRT</th><th>Mask</th><th></th></tr>
                     <tr><td style="text-align:right">R</td><td><input type="text" class="audioInputs" id="spch_aud-srt-r"></td><td><input type="text" class="audioInputs"></td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
                     <tr><td style="text-align:right">L</td><td><input type="text" class="audioInputs" id="spch_aud-srt-l"></td><td><input type="text" class="audioInputs"></td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
                     <tr><td style="text-align:right">Binaural</td><td><input type="text" class="audioInputs" id="spch_aud-srt-l"></td><td><input type="text" class="audioInputs"></td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
                  </table>
                </div>
            </div>
            <div class="col-xs-4">
                <div class="panel panel-default audioInputs-container">
                  <!-- Default panel contents -->
                  <div class="panel-heading audioInputs-heading">Word Recognition</div>
                  <!-- Table -->
                  <table class="table audioInputs-table">
                     <tr style="text-align:center"><th></th><th>%</th><th>Stimulus</th><th>Mask</th><th>Noise</th></tr>
                     <tr><td style="text-align:right">R</td><td><input type="text" class="audioInputs"></td><td><input type="text" class="audioInputs"></td><td><input type="text" class="audioInputs"></td><td><input type="text" class="audioInputs"></td></tr>
                     <tr><td style="text-align:right">L</td><td><input type="text" class="audioInputs"></td><td><input type="text" class="audioInputs"></td><td><input type="text" class="audioInputs"></td><td><input type="text" class="audioInputs"></td></tr>
                     <tr><td style="text-align:right">Binaural</td><td><input type="text" class="audioInputs"></td><td><input type="text" class="audioInputs"></td><td><input type="text" class="audioInputs"></td><td><input type="text" class="audioInputs"></td></tr>
                  </table>
                </div>
            </div>
            <div class="col-xs-2"></div>
        </div>
    </div>
    </div> <!-- End Container --> 
    <script>
    $(function() {
        //combine stuff later        
        
        var stage_right = new Kinetic.Stage({
            container: 'audiogram_right',
            width: 500,
            height: 500
        });
        
        var stage_left = new Kinetic.Stage({
            container: 'audiogram_left',
            width: 500,
            height: 500
        });
        
        var Stage = {};
        
        //create both canvas' and add 'right-click' event handlers to each canvas
        //should be handled in audiogram.js
        //setTimeout(function(){
            Stage['right'] = new AudioGram(stage_right,100,'right','audiogram_right');
            Stage['left'] = new AudioGram(stage_left,200,'left','audiogram_left');
            Stage['right'].bindContextMenu();
            Stage['left'].bindContextMenu();       
//            setTimeout(function(){
//                document.getElementById('audiogram_right').addEventListener('contextmenu', function (event) {
//                    event.preventDefault();
//                    Stage['right'].showContextMenu(this);
//                });
//                document.getElementById('audiogram_left').addEventListener('contextmenu', function (event) {
//                    event.preventDefault();
//                    Stage['left'].showContextMenu(this);
//                });
//            },0);
//        },0);


        $( ".mea-btn" ).on( "click", function(event) {
            var clicked = $( this )[0].id;
                setTimeout( function (){
                    $( ".mea-btn" ).each(function( index ) {
                        if($( this )[0].id != 'mask-button'){
                            if(clicked == $( this )[0].id){
                                $( this ).addClass('border');
                                $( this ).blur();
                            }else{
                                $( this ).removeClass('border');
                            }
                        }
                    })
                    setTimeout( function (){
                        $( ".mea-btn" ).each(function( index ) {
                            if($( this ).hasClass( "border" )){
                                Stage['right'].setMeasureType(clicked);
                                Stage['left'].setMeasureType(clicked);
                            }
                        });
                    }, 0 );
                }, 0 );
        });
        
        $('.audiogram-menu').on('click', function(event) {
            var side = $( this ).attr('data');
            var action = $(event.target).closest('button').attr("data");
            var current = null;

            switch(action){
                case 'Refresh': Stage[side].clear();
                                break;
                case 'Undo':    Stage[side].undo();
                                break;
                case 'Redo':    Stage[side].redo();
                                break;
            }
            $(event.target).closest('button').blur();
        });
        $('#printAudiogram').on('click', function(event) {
            //Stage['right'].getAudiogram();
            //Stage['left'].getAudiogram();
            
            var ImgData = {};   //Json object image data to be posted back and combined.
            ImgData['background'] = null;
            ImgData['right'] = {};
            ImgData['left'] = {};
            var canvass = null //Will hold the multiple layers of canvas' that are created
                
            canvass = $("#audiogram_right").find(".kineticjs-content").children();
            //console.log(canvass.length);
            ImgData['background'] = canvass[0].toDataURL("image/png");
            ImgData['right']['line'] = canvass[1].toDataURL("image/png");
            ImgData['right']['measures'] = canvass[2].toDataURL("image/png");  
            
            canvass = $("#audiogram_left").find(".kineticjs-content").children();
            ImgData['left']['line'] = canvass[1].toDataURL("image/png");
            ImgData['left']['measures'] = canvass[2].toDataURL("image/png");            
            //console.log(ImgData);
            //var img = ImgData['right']['line'].toDataURL("image/png");
            //$("#temp1").html('<img src="'+img+'"/>');

            $.post( "class.audiogram.php", ImgData)
                .done(function( data ) {
                    console.log( "Data Loaded: " + data );
            });
        });
        $('#saveAudiogram').on('click', function(event) {
             $.post( "class.audiogram.php", SaveData)
                .done(function( data ) {
                       //console.log( "Data Loaded: " + data );
                });           
        });
        $('#searchAudiogram').on('click', function(event) {
            $.post( "class.audiogram.php", searchData)
                .done(function( data ) {
                       //console.log( "Data Loaded: " + data );
                });           
        });
        window.onbeforeunload = enableBeforeUnload;
        
        //Added for checkbox buttons
       $('.button-checkbox').each(function () {

            // Settings
            var $widget = $(this),
                $button = $widget.find('button'),
                $checkbox = $widget.find('input:checkbox'),
                color = $button.data('color'),
                settings = {
                    on: {
                        icon: 'fa fa-check-square-o'
                    },
                    off: {
                        icon: 'fa fa-ban'
                    }
                };

            // Event Handlers
            $button.on('click', function () {
                $checkbox.prop('checked', !$checkbox.is(':checked'));
                $checkbox.triggerHandler('change');
                updateDisplay();
            });
            $checkbox.on('change', function () {
                updateDisplay();
            });

            // Actions
            function updateDisplay() {
                var isChecked = $checkbox.is(':checked');

                // Set the button's state
                $button.data('state', (isChecked) ? "on" : "off");

                // Set the button's icon
                $button.find('.state-icon')
                    .removeClass()
                    .addClass('state-icon ' + settings[$button.data('state')].icon);

                // Update the button's color
                if (isChecked) {
                    $button
                        .removeClass('btn-default')
                        .addClass('btn-' + color + ' active')
                        .blur();
                        Stage['right'].setMasked(1);
                        Stage['left'].setMasked(1);
                        $('#BCL').html('&nbsp;&nbsp;]');
                        $('#BCR').html('[&nbsp;&nbsp;');        
                        $('#ACL').html('<i class="fa fa-square-o"></i>');
                        $('#ACR').html('&#x25b3;');
                } else {
                    $button
                        .removeClass('btn-' + color + ' active')
                        .addClass('btn-default')
                        .blur();
                        Stage['right'].setMasked(0);
                        Stage['left'].setMasked(0);  
                        $('#BCR').html('<i class="fa fa-chevron-left"></i>&nbsp;');
                        $('#BCL').html('&nbsp;<i class="fa fa-chevron-right"></i>');
                        $('#ACR').html('<i class="fa fa-circle-o"></i>');
                        $('#ACL').html('&#10005;');
                }
            }

            // Initialization
            function init() {

                updateDisplay();

                // Inject the icon if applicable
                if ($button.find('.state-icon').length == 0) {
                    $button.prepend('<i class="state-icon ' + settings[$button.data('state')].icon + '"></i> ');
                }
            }
            init();
        });
    });
    function enableBeforeUnload() {
        window.onbeforeunload = function (e) {
            return "Are you sure you want to navigate away?";
        };
    }
     $("#audiogramTitleID").chosen({
        disable_search_threshold: 10,
        no_results_text: "Oops, nothing found!",
        width: "95%"
      });
    </script>      
  </body>
</html>