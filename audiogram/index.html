<!DOCTYPE html>
<html lang="en">
<head>

    <!--CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
    <link href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.6.2/css/bootstrap-select.min.css' rel='stylesheet' type='text/css'>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    
    <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Indie+Flower' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Play:400,700' rel='stylesheet' type='text/css'>

    
    <!--JavaScript -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.6.2/js/bootstrap-select.min.js"></script>
    <script src="js/kinetic.js"></script>
    <script src="js/context.js"></script> 
    <script src="js/contextMenu.js"></script>
    <script src="js/audiogram.js"></script>

    <!-- https://github.com/js-coder/cookie.js -->
    <script src="js/cookie.min.js"></script>

    <style>
        /* scheme 1 */
        /* turquiose #64D4F9 */
        /* robins egg #15C2D2 */
        /* orange yellow #F7C868 */
        /* light carmine pink #F16767 */
        /* mamba #776A7D */

        /* scheme 2 */
        /*dark cyan #008D8E*/
        /*robins egg blue #15C8D1*/
        /*gray #808281*/
        /*white lilac #E5E7E6*/

        /* tin #7E7E7E */
        /* gray #818181 */
        body{
            color:#3C3F41;
            background-color: #CEE0E9;
            padding-top:10px;
/*            font-family: 'Inconsolata', ;*/
/*            font-family: 'Indie Flower', cursive;*/
            font-family: 'Play', sans-serif;
        }
        
/*        .btn-warning{
            background-image: linear-gradient(to bottom,#f74242 0,#f9a4a4 100%);
        }
*/
        
        h2 {
            color:#414141;
            text-shadow: 2px 2px #808281;
        }
        h3.panel-title{
            font-weight:bold;
        }
        
        .list-group-wrap{
            margin: 0 auto; 
            text-align: center;
        }
        
        .navbar{
            margin-left:15px;
            margin-right:15px;
        }
        
        .navbar-default .navbar-brand{
            color:#15C2D2;
            font-size:20px;
        }
        
        .navbar-default .navbar-brand.subheading{
            color:#777;
            font-size:14px;
        }
        
        #patient-audiogram-date{
            width:100%
        }
        
        /*Aii styles*/
        
        .aii-btn-border{
            border: 3px solid rgba(0,0,0,.3);
            background-color: #EEEEEE;
        }
        
        .aii-canvas{
            text-align:center;
            margin-top:-20px;
        }
        
        .aii-canvas-menu{
            text-align:center;
        }
        
        .aii-center-column{
            margin: 0 auto; 
            text-align: center;
        }
        
        .aii.control-label{
            font-size:16px;
            font-weight:normal;
            padding-top:5px;
        }
        
        .aii.fa{
            padding-top:3px;
        }
        
        .aii.input-label{
            font-weight:bold;
            padding:5px;
            text-align:right;
        }
                
        .aii.form-control{
            font-weight:bold;
        }
        
        #aii-main-container{
            padding: 0px;
            background-color: #E5E7E6;
            -moz-box-shadow: 0 0 5px 5px rgba(200,200,200,0.5);
            -webkit-box-shadow: 0 0 5px 5px rgba(200,200,200,0.5);
            box-shadow: 0 0 5px 5px rgba(200,200,200,0.5);
            /*padding: 5px 25px 25px 25px;*/
        }
        
        #measure-buttons{
            width:130px;
        }
        
        .aii-mea-btn{
/*            width:130px;*/
            border:3px solid rgba(0,0,0,0);
        }     
        
        .aii-mea-btn.mid{
            margin-left:5px;
            margin-right:5px;
        }
        
        .aii-mea-btn.left{
            font-size:20px;
            font-weight:bold;
            text-align: left;
        }
        
        .aii-mea-btn.right{
            font-size:20px;
            font-weight:bold;
            text-align: right;
        }
        
        #aii-navbar{
            font-size:20px;
        }
        
        .aii.panel.panel-default{
            background:rgba(255,255,255,.5);
        }
        
        .aii.panel.panel-default.patient-info{        
            padding-bottom:10px;
            height:160px;
        }
        
        .aii.panel-heading{
            font-size:20px
        }
        
        .aii.row{
            margin:10px 0px 5px 0px;
/*            padding-left:10px;*/
        }
        
        
        /*Sawr - styles added to speech audiometry and word recognition */
        .sawr-input{
            width:45px;
            text-align:right;
            padding:3px;
        }
        
        .sawr.panel-heading{
            font-size:16px;
            font-weight:bold;
        }
        
        .sawr-table td,th{
            text-align: center;
        }
        

        
    </style>
    
    </head>
    <body>
        <div class="container" id="aii-main-container">
            <!-- Start Menu bar -->
            <div class="row">
                <nav class="navbar navbar-default navbar-xs" role="navigation">
                    <!-- Brand and toggle get grouped for better mobile display -->
                    <div class="navbar-header">
                        <a class="navbar-brand" href="#"><b>Aii</b> Audiogram</a> 
                        <span class="navbar-brand subheading" id="facility-name">Facility Name</span>
                    </div>
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse pull-right" id="aii-navbar">
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown"><b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    <li><a href="#"><i class="fa fa-search"></i> Search Audiogram</a></li>
                                    <li><a href="#" class="saveAudiogram"><i class="fa fa-save"></i> Save Audiogram</a></li>
                                    <li><a href="#"><i class="fa fa-print"></i> Print Audiogram</a></li>
                                    <li class="divider"></li>
                                    <li><a href="#" id="toggle-patient-info"><i class="fa fa-caret-square-o-up"></i> Hide Patient Info</a></li>
                                    <li class="divider"></li>
                                    <li><a href="#">One more separated link</a></li>
                                </ul>
                            </li>
                            <li><a href="#" id="searchAudiogram"><i class="fa fa-search"></i></a></li>
                            <li><a href="#" class="saveAudiogram"><i class="fa fa-save"></i></a></li>
                            <li><a href="#" id="printAudiogram"><i class="fa fa-print"></i></a></li>
                        </ul>
                    </div><!-- /.navbar-collapse -->
                </nav>
            </div>
            <!-- End Menu bar -->
            <!-- Start Patient Info Row -->
            <div class="row" id="patient-info">
                <div class="col-sm-4">
                    <div class="panel panel-default aii patient-info" style="margin-left:15px">
                        <div class="panel-heading aii">
                            <h3 class="panel-title">Patient Info</h3>
                        </div>
                        <div class="row aii">
                            <div class="form-group">
                                <label for="date" class="col-sm-3 control-label">Name:</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="patient-name" place-holder="Patient Name" disabled>
                                </div>
                            </div> 
                        </div>
                        <div class="row aii">
                            <div class="form-group">
                                <label for="date" class="col-sm-3 control-label">DOB:</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="patient-dob" placeholder="DOB" disabled>
                                </div>
                            </div> 
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="panel panel-default aii patient-info">
                        <div class="panel-heading aii">
                            <h3 class="panel-title"id="patient-phase"></h3>
                        </div>
                        <div class="row aii">
                            <div class="form-group">
                            <label for="date" class="col-sm-3 control-label">Title:</label>
                            <select class="selectpicker show-tick" data-style="btn-default" id="aii-audiogram-title-new">
                                <option value="" disabled selected>Audiogram title...</option>
                                <option>Pre Operative Audiogram</option>
                                <option>Aided Testing</option>
                                <option>Residual Hearing</option>
                              </select>
                            </div>
<!--
                            <div class="form-group">
                                <label for="status" class="col-sm-3 control-label">Title:</label>
                                <div class="col-sm-9">
                                    <select class="form-control error" id="status" name="status"  id="aii-audiogram-title-new">
                                        <option value="" disabled selected>Audiogram title...</option>
                                        <option>Pre Operative Audiogram</option>
                                        <option>Aided Testing</option>
                                        <option>Residual Hearing</option>
                                    </select>
                                </div>
                            </div>
-->
                        </div>
                        <div class="row aii">
                            <div class="form-group">
                                <label for="date" class="col-sm-2 control-label">Date:</label>
                                <div class="col-sm-8">
                                    <input type="date" class="form-control aii" id="patient-audiogram-date">
                                </div>
                            </div> 
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="panel panel-default aii patient-info" style="margin-right:15px">
                        <div class="panel-heading aii">
                            <h3 class="panel-title">Search</h3>
                        </div>
                            <div class="row">
                                <div class="col-xs-1 col-sm-1"></div>
                                <div class="col-xs-10 col-sm-10">
                                    <div class="input-group">
                                      <div class="input-group-btn">
                                        <button type="button" class="btn btn-default" data-toggle="dropdown" aria-expanded="false"><i class="fa fa-search"></i><span class="caret"></span></button>
                                        <ul class="dropdown-menu" role="menu">
                                          <li><a href="#">Pre Operative Audiogram</a></li>
                                          <li><a href="#">Aided Testing</a></li>
                                          <li><a href="#">Residual Hearing</a></li>
                                        </ul>
                                      </div><!-- /btn-group -->
                                      <input type="text" class="form-control aii">
                                    </div>
                                </div>
                                <div class="col-xs-1 col-sm-1"></div>
                            </div>
                            <div class="row">
                                <div class="col-xs-2 col-sm-2">
                                </div>
                                <div class="col-xs-8 col-sm-8 ">
                                </div>
                            </div>   
                    </div>
                 </div>
            </div>
            <!-- End Patient Info Row -->

            <!-- Start Ear Condition Row -->
            <div class="container" id="aii-controls-container">
                <div class="row">
                    <!-- Begin Right Column -->
                    <div class="col-sm-5">
                            <div class="panel panel-default aii">
                              <div class="panel-heading sawr">
                                <h3 class="panel-title">Right Ear</h3>
                              </div>
                              <div class="panel-body">
                                <div class="row">
                                    <div class="form-group">
                                        <label for="status" class="col-sm-3 control-label aii">Condition: </label>
                                        <div class="col-sm-7">
                                            <select class="selectpicker show-tick" id="right-condition-opts">
                                                <option value="" disabled selected>Choose ear condition...</option>
                                            </select>
                                        </div>
                                        <div class="col-sm-2"></div>
                                    </div>
                                </div>
                                <!-- Begin Right Canvas -->
                                <div class="row">   
                                    <div class="aii-canvas"  id="left_column">
                                        <div class="audiogram-container" id="audiogram_right"></div>
                                    </div>
                                </div>              
                                <!-- End Right Canvas -->
                                <!-- Begin Menu Row -->
                                <div class="row">
                                    <div class="aii-canvas-menu" data="right">
                                        <button class="btn btn-default btn-xs" data="Undo" id="undo"><i class="fa fa-undo pull-left aii"></i>Undo</button>
                                        <button class="btn btn-default btn-xs" data="Refresh" id="refresh"><i class="fa fa-refresh pull-left aii"></i>Clear</button>
                                        <button class="btn btn-default btn-xs" data="Redo" id="redo"><i class="fa fa-repeat pull-left aii"></i>Redo</button>
                                    </div>
                                </div> 
                            </div>
                        </div>
                    </div>
                    <!-- End Right Column -->
                    <!-- Begin Middle Column -->
                    <div class="col-sm-2" id="aii-center-column">
                        <!-- Auditory measure buttons -->
                        <div class="list-group-wrap">
                            <div class="panel panel-default aii">
                              <div class="panel-heading">
                                <h3 class="panel-title">Measures</h3>
                              </div>
                              <div class="panel-body">
                                    <div class="list-group" id="measure-buttons">
                                        <a href="#" class="list-group-item aii-mea-btn aii-btn-border" id="AC">
                                            <span class="aii-mea-btn left" id="ACR"><i class="fa fa-circle-o"></i>&nbsp;&nbsp;</span><span class="aii-mea-btn mid">AC</span>&nbsp;&nbsp;<span class="aii-mea-btn right" id="ACL">&#10005;</span>
                                        </a>
                                        <a href="#" class="list-group-item aii-mea-btn" id="BC">
                                            <span class="aii-mea-btn left" id="BCR">&nbsp;&nbsp;<i class="fa fa-chevron-left"></i></span><span class="aii-mea-btn mid">BC</span>&nbsp;&nbsp;<span class="aii-mea-btn right" id="BCL"><i class="fa fa-chevron-right"></i></span>
                                        </a>
                                        <a href="#" class="list-group-item aii-mea-btn" id="MCL">
                                            <span class="aii-mea-btn left">M</span>&nbsp;&nbsp;<span class="aii-mea-btn mid">MCL</span>&nbsp;&nbsp;<span class="aii-mea-btn right">M</span>
                                        </a>
                                        <a href="#" class="list-group-item aii-mea-btn" id="UCL">
                                            <span class="aii-mea-btn left">m</span>&nbsp;&nbsp;<span class="aii-mea-btn mid">UCL</span>&nbsp;&nbsp;<span class="aii-mea-btn right">m</span>
                                        </a>
                                        <a href="#" class="list-group-item aii-mea-btn" id="SF">
                                            <span class="aii-mea-btn left">S</span>&nbsp;&nbsp;&nbsp;<span class="aii-mea-btn mid">SF</span>&nbsp;&nbsp;&nbsp;<span class="aii-mea-btn right">S</span>
                                        </a>
                                        <a href="#" class="list-group-item aii-mea-btn" id="SF-A">
                                            <span class="aii-mea-btn left">A</span>&nbsp;<span class="aii-mea-btn mid">SF-A</span>&nbsp;<span class="aii-mea-btn right">A</span>
                                        </a>
                                    </div> 
                                    <div>
                                        <span class="button-checkbox">
                                            <button type="button" class="btn" id="mask-tool"> Masked</button>
                                            <input type="checkbox" class="hidden" />
                                        </span>
                                    </div>
                              </div>
                            </div>

                        </div>
                    </div>
                    <!-- End Middle Column -->
                    <!-- Begin Left Column -->
                    <div class="col-sm-5">
                            <div class="panel panel-default aii">
                              <div class="panel-heading">
                                <h3 class="panel-title">Left Ear</h3>
                              </div>
                              <div class="panel-body">
                                <div class="row">
                                    <div class="form-group">
                                        <label for="status" class="col-sm-3 control-label aii">Condition: </label>
                                        <div class="col-sm-7">
                                            <select class="selectpicker show-tick" id="left-condition-opts">
                                                <option value="" disabled selected>Choose ear condition...</option>
                                            </select>
                                        </div>
                                        <div class="col-sm-2"></div>
                                    </div>
                                </div>
                                <!-- Begin Right Canvas -->
                                <div class="row">   
                                    <div class="aii-canvas"  id="right_column">
                                        <div class="audiogram-container" id="audiogram_left"></div>
                                    </div>
                                </div>              
                                <!-- End Right Canvas -->
                                <!-- Begin Menu Row -->
                                <div class="row">
                                    <div class="aii-canvas-menu" data="left">
                                        <button class="btn btn-default btn-xs" data="Undo" id="undo"><i class="fa fa-undo pull-left aii"></i>Undo</button>
                                        <button class="btn btn-default btn-xs" data="Refresh" id="refresh"><i class="fa fa-refresh pull-left aii"></i>Clear</button>
                                        <button class="btn btn-default btn-xs" data="Redo" id="redo"><i class="fa fa-repeat pull-left aii"></i>Redo</button>
                                    </div>
                                </div> 
                            </div>
                        </div>
                    </div>
                    <!-- End Left Column -->
                </div>
            </div>
            <!-- End Ear Condition Row -->
            <div class="row">
                <div class="col-xs-2 aii-center-menu">

                </div>
                <!-- End Button Column-->
            </div> 
            <!-- End Row -->
            <div class="row">
                <div class="col-xs-1"></div>
                <div class="col-xs-5">
                    <div class="panel panel-default aii">
                        <!-- Default panel contents -->
                        <div class="panel-heading sawr">
                            <h3 class="panel-title">Speech Audiometry:</h3>
                        </div>
                        <!-- Table -->
                        <table class="table table-condensed sawr-table">
                            <tr style="text-align:center"><th></th><th>SRT</th><th>Mask</th><th></th></tr>
                            <tr><td style="text-align:right">R</td><td><input type="text" class="sawr-input" id="spch-aud-srt-r"></td><td><input type="text" class="sawr-input" id="spch-aud-mask-r"></td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
                            <tr><td style="text-align:right">L</td><td><input type="text" class="sawr-input" id="spch-aud-srt-l"></td><td><input type="text" class="sawr-input" id="spch-aud-mask-l"></td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
                            <tr><td style="text-align:right">Binaural</td><td><input type="text" class="sawr-input" id="spch-aud-srt-b"></td><td><input type="text" class="sawr-input" id="spch-aud-mask-b"></td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
                        </table>
                    </div>
                </div>
                <div class="col-xs-5">
                    <div class="panel panel-default aii">
                        <!-- Default panel contents -->
                        <div class="panel-heading sawr">
                            <h3 class="panel-title">Word Recognition:</h3>
                        </div>
                        <!-- Table -->
                        <table class="table table-condensed sawr-table">
                            <tr style="text-align:center"><th></th><th>%</th><th>Stimulus</th><th>Mask</th><th>Noise</th></tr>
                            <tr><td style="text-align:right">R</td><td><input type="text" class="sawr-input" id="word-rec-per-r"></td><td><input type="text" class="sawr-input" id="word-rec-stim-r"></td><td><input type="text" class="sawr-input" id="word-rec-mask-r"></td><td><input type="text" class="sawr-input" id="word-rec-noise-r"></td></tr>
                            <tr><td style="text-align:right">L</td><td><input type="text" class="sawr-input" id="word-rec-per-l"></td><td><input type="text" class="sawr-input" id="word-rec-stim-l"></td><td><input type="text" class="sawr-input" id="word-rec-mask-l"></td><td><input type="text" class="sawr-input" id="word-rec-noise-l"></td></tr>
                            <tr><td style="text-align:right">Binaural</td><td><input type="text" class="sawr-input" id="word-rec-per-b"></td><td><input type="text" class="sawr-input" id="word-rec-stim-b"></td><td><input type="text" class="sawr-input" id="word-rec-mask-b"></td><td><input type="text" class="sawr-input" id="word-rec-noise-b"></td></tr>
                        </table>
                    </div>
                </div>
                <div class="col-xs-1"></div>
            </div>
            <div class="row">
               <div class="col-xs-10"></div><div class="col-xs-2"><a class="btn btn-default saveAudiogram" href="#" role="button"><i class="fa fa-save"></i> Save</a></div>
            </div>
        </div> <!-- End Container --> 
    <script>
        
        $(function() {
            //combine stuff later
            $( "a" ).click(function( event ) {
              event.preventDefault();
            });
            
            var stage_right = new Kinetic.Stage({
                container: 'audiogram_right',
                width: 450,
                height: 450
            });

            var stage_left = new Kinetic.Stage({
                container: 'audiogram_left',
                width: 450,
                height: 450
            });

            var Stage = {};
            var cookieData = null;
            var conditionChoices = null;
            
            //create both canvas' and add 'right-click' event handlers to each canvas
            //should be handled in audiogram.js
            //setTimeout(function(){
            Stage['right'] = new AudioGram(stage_right,100,'right','audiogram_right');
            Stage['left'] = new AudioGram(stage_left,200,'left','audiogram_left');
            Stage['right'].bindContextMenu();
            Stage['left'].bindContextMenu();  
            Stage['right'].bindKeyPress();
            Stage['left'].bindKeyPress();


            $( ".aii-mea-btn" ).on( "click", function(e) {
                var clicked = $( this )[0].id;
                setTimeout( function (){
                    $( ".aii-mea-btn" ).each(function( index ) {
                        if($( this )[0].id != 'mask-button'){
                            if(clicked == $( this )[0].id){
                                $( this ).addClass('aii-btn-border');
                                $( this ).blur();
                            }else{
                                $( this ).removeClass('aii-btn-border');
                            }
                        }
                    })
                    setTimeout( function (){
                        $( ".aii-mea-btn" ).each(function( index ) {
                            if($( this ).hasClass( "aii-btn-border" )){
                                Stage['right'].setMeasureType(clicked);
                                Stage['left'].setMeasureType(clicked);
                            }
                        });
                    }, 0 );
                }, 0 );
                e.preventDefault();
            });

            $('.aii-canvas-menu').on('click', function(event) {
                var side = $( this ).attr('data');
                var action = $(event.target).closest('button').attr("data");
                var current = null;

                switch(action){
                    case 'Refresh': Stage[side].clear();
                        break;
                    case 'Undo':    Stage[side].undo();
                        break;
                    case 'Redo':    Stage[side].redo();
                        break;
                }
                $(event.target).closest('button').blur();
                event.preventDefault();
            });
            
            $('#printAudiogram').on('click', function(event) {
                var canvas_right = $("#audiogram_right").find(".kineticjs-content").children();
                var canvas_left = $("#audiogram_left").find(".kineticjs-content").children();
                var ImgData = {
                    "action" : "print",
                    "background" : canvas_right[0].toDataURL("image/png"),
                    "right" : {
                        "line" : canvas_right[1].toDataURL("image/png"),
                        "measures" : canvas_right[2].toDataURL("image/png")
                    },
                    "left" : {
                        "line" : canvas_left[1].toDataURL("image/png"),
                        "measures" : canvas_left[2].toDataURL("image/png")
                    }
                }
            
                console.log(ImgData);

                $.post( "class.audiogram.php", ImgData)
                .done(function( data ) {
                    console.log( "Data Loaded: " + data );
                });
                event.preventDefault();
            });
            
            $('.saveAudiogram').on('click', function(event) {
                
                checkSaveError($('#aii-audiogram-title-new'),'Title Needed...');
                checkSaveError($('#right-condition-opts'),'Condition Needed...');
                checkSaveError($('#left-condition-opts'),'Condition Needed...');
                
                var AudiogramData = {
                    "Action" : "saveAudiogram",
                    "Token": cookieData.SessionID,
                    "patient_data" : {
                        "patient-audiogram-date" : $("#patient-audiogram-date").attr("value"),
                        "patient-name" : $('#patient-name').val(),
                        "patient-dob" : $('#patient-dob').val(),
                        "patient-audiogramTitle-new" : $('#aii-audiogramTitle-new option:selected').val(),
                        "CareTeamID": "1018",
                        "CurrentPhaseID": "7",
                        "PatientID": "1018"
                    },
                    "sawr" : {
                        "spch-aud-srt-r":$('#spch-aud-srt-r').val(),
                        "spch-aud-srt-l":$('#spch-aud-srt-l').val(),
                        "spch-aud-srt-b":$('#spch-aud-srt-b').val(),
                        "spch-aud-mask-r":$('#spch-aud-mask-r').val(),
                        "spch-aud-mask-l":$('#spch-aud-mask-l').val(),
                        "spch-aud-mask-b":$('#spch-aud-mask-b').val(),
                        "word-rec-per-r":$('#word-rec-per-r').val(),
                        "word-rec-per-l":$('#word-rec-per-l').val(),
                        "word-rec-per-b":$('#word-rec-per-b').val(),
                        "word-rec-stim-r":$('#word-rec-stim-r').val(),
                        "word-rec-stim-l":$('#word-rec-stim-l').val(),
                        "word-rec-stim-b":$('#word-rec-stim-b').val(),
                        "word-rec-mask-r":$('#word-rec-mask-r').val(),
                        "word-rec-mask-l":$('#word-rec-mask-l').val(),
                        "word-rec-mask-b":$('#word-rec-mask-b').val(),
                        "word-rec-noise-r":$('#word-rec-noise-r').val(),
                        "word-rec-noise-l":$('#word-rec-noise-l').val(),
                        "word-rec-noise-b":$('#word-rec-noise-b').val()
                    },
                    "condition":{
                        "left": $('#left-condition-opts option:selected').val(),
                        "right":$('#right-condition-opts option:selected').val()
                    },
                    "measures" : {
                        "left": Stage['left'].getAudiogramMeasures(),
                        "right": Stage['right'].getAudiogramMeasures()
                    }
                };
                
                //OK! If I pass AudiogramData as the above object to my $.post, the kinetic canvas (Stage) literally
                //gets destroyed ?!? I have no clue. Just by converting the "object" to a string so I 
                //could analyze it better I noticed that it didn't destroy...
                AudiogramData = JSON.stringify(AudiogramData);
                AudiogramData = eval('(' + AudiogramData + ')');
                //console.log(AudiogramData);               
//                $.post("class.audiogram.php", AudiogramData)
//                .done(function( data ) {
//                    console.log( data );
//                });
                
                $.post("http://aii-hermes.org/aii-api/v1/audiograms", AudiogramData)
                .done(function( data ) {
                    console.log( data );
                });
                
                event.preventDefault();
            });
            
            $('#searchAudiogram').on('click', function(event) {
                $.post("class.audiogram.php", searchData)
                .done(function( data ) {
                    console.log( "Data Loaded: " + data );
                });
                event.preventDefault();
            });
            
            $('#aii-audiogram-title-ul li').on('click', function(event) {
                var $this = $(this);
                $('#aii-audiogram-title-new').val($(this).text());
                event.preventDefault();
            });
            
            $('#aii-audiogram-title-new').on('focus', function(event) {
                console.log("focused");
                $('#aii-audiogram-title-new').blur();
                $('#aii-audiogram-title-ul').focus();
                $('#aii-audiogram-title-new').siblings("div").addClass('open');
            });
        
            //Added for checkbox buttons
            $('.button-checkbox').each(function () {

                // Settings
                var $widget = $(this),
                    $button = $widget.find('button'),
                    $checkbox = $widget.find('input:checkbox'),
                    color = $button.data('color'),
                    settings = {
                        on: {
                            icon: 'fa fa-check-square-o'
                        },
                        off: {
                            icon: 'fa fa-ban'
                        }
                    };

                // Event Handlers
                $button.on('click', function () {
                    $checkbox.prop('checked', !$checkbox.is(':checked'));
                    $checkbox.triggerHandler('change');
                    updateConditionButtons();
                    event.preventDefault();
                });
                
                $checkbox.on('change', function () {
                    updateConditionButtons();
                });
                
            });

            
            $('#toggle-patient-info').on('click', function () {
                if($('#patient-info').hasClass('hidden')){
                    $( "#patient-info" ).slideDown( "slow", function() {
                        $('#toggle-patient-info').html('<i class="fa fa-caret-square-o-up"></i> Hide Patient Info');
                        $('#patient-info').removeClass('hidden');
                    });
                }else{
                    $( "#patient-info" ).slideUp( "slow", function() {
                        $('#toggle-patient-info').html('<i class="fa fa-caret-square-o-down"></i> Show Patient Info');
                        $('#patient-info').addClass('hidden');
                    });
                }
                event.preventDefault();
            });

            $('#show-patient-info').on('click', function () {
                $('#patient-info').css('display','block');
                $('#hide-patient-info').css('display','block');
                $('#show-patient-info').css('display','none');
                event.preventDefault();
            });
            
            function checkSaveError(ele,message){
                
                console.log(ele);
                var $ele = ele
                var title = $ele.val();
                
                console.log("Title: "+title);
                                
                if(title == "" || title == null){
                    console.log("error-title");
                    $ele.selectpicker('setStyle', 'btn-danger', 'add');
                }
                
                $ele.on('change',function(){
                    console.log("changed");
                    $ele.selectpicker('setStyle', 'btn-danger', 'remove').selectpicker('refresh');;                  
                });
            }
            

            
            function updateConditionButtons() {
                // Settings
                var $widget = $('.button-checkbox'),
                    $button = $widget.find('button'),
                    $checkbox = $widget.find('input:checkbox'),
                    color = $button.data('color'),
                    isChecked = $checkbox.is(':checked'),
                    settings = {
                        on: {
                            icon: 'fa fa-check-square-o'
                        },
                        off: {
                            icon: 'fa fa-ban'
                        }
                    };

                // Set the button's state
                $button.data('state', (isChecked) ? "on" : "off");

                // Set the button's icon
                $button.find('.state-icon')
                .removeClass()
                .addClass('state-icon ' + settings[$button.data('state')].icon);

                // Update the button's color
                if (isChecked) {
                    $button
                    .removeClass('btn-default')
                    .addClass('btn-' + color + ' active')
                    .blur();
                    Stage['right'].setMasked(1);
                    Stage['left'].setMasked(1);
                    $('#BCL').html('&nbsp;&nbsp;]');
                    $('#BCR').html('[&nbsp;&nbsp;');        
                    $('#ACL').html('<i class="fa fa-square-o"></i>');
                    $('#ACR').html('&#x25b3;');
                } else {
                    $button
                    .removeClass('btn-' + color + ' active')
                    .addClass('btn-default')
                    .blur();
                    Stage['right'].setMasked(0);
                    Stage['left'].setMasked(0);  
                    $('#BCR').html('<i class="fa fa-chevron-left"></i>&nbsp;');
                    $('#BCL').html('&nbsp;<i class="fa fa-chevron-right"></i>');
                    $('#ACR').html('<i class="fa fa-circle-o"></i>');
                    $('#ACL').html('&#10005;');
                }
            }
            
            // Initialization
            function init() {
                setTimeout( function (){
                    //Gets cookies from current session
                    cookieData = getCookieData();
                    
                    console.log('cookie:');
                    console.log(cookieData);

                    //If the cookie timed out, redirect home
                    if(cookieData['BadToken'] == 'Token Timeout'){
                        window.location.href = '/cochlearProject/';
                    }

                    //Put condition buttons in the proper state
                    updateConditionButtons();

                    setTimeout( function (){
                        
                        populateConditionChoices(cookieData);
                        
                        loadPatientData(cookieData);
                        
                        var $button = $('.button-checkbox').find('button');
                        var settings = {
                            on: {
                                icon: 'fa fa-check-square-o'
                            },
                            off: {
                                icon: 'fa fa-ban'
                            }
                        };
                        // Inject the icon if applicable next to the masked button.
                        if ($button.find('.state-icon').length == 0) {
                            $button.prepend('<i class="state-icon '+settings[$button.data('state')].icon + '"></i>');
                        }
                    }, 0 );
                }, 0 );                                    
            }
            
            init();

            setTodaysDate();
            
            //testing only
            loadSpeechWordData();
            
            //Library for bootstrap dropdowns.
            $('.selectpicker').selectpicker();
            
        });

        /**
        * Gets the unique condition choices for each ear (cochlear, unaided, etc.)
        * @param {void}
        * @return {void}
        */ 
        function populateConditionChoices(cookie_data){
            
            $.post("class.audiogram.php", { "Token": cookie_data.SessionID, "Action": "getConditions" })
            .done(function( json ) {
                json = eval( "(" + json + ")" );
                var List = [];
                var Html = "";
                for (var key in json) {
                    List.push(key);
                }
                List.sort();
                
                Html = '<option value="" disabled selected>Choose ear condition...</option>';
                
                for(var i=0;i<List.length;i++){
                    Html = Html + '<option value="'+List[i]+'">'+List[i]+'</option>';
                }
                
                console.log(List);
                
                $('#right-condition-opts').html(Html).selectpicker('refresh');
                $('#left-condition-opts').html(Html).selectpicker('refresh');
//                $('#left-condition-opts').html(Html); 
//                $('#left-condition-opts li').on('click', function(e) {
//                    var $this = $(this);
//                    $('#left-condition-choice').val($(this).text());
//                    e.preventDefault();
//                }); 
//                
//                $('#right-condition-opts').html(Html); 
//                $('#right-condition-opts li').on('click', function(e) {
//                    var $this = $(this);
//                    $('#right-condition-choice').val($(this).text());
//                    e.preventDefault();
//                });
            });
        }        
        
        /**
        * Trims extra double quotes and single quotes off of strings. I used a locally created
        * object because of some funny behavior I couldnt track down quickly.
        * @param {void}
        * @return {object} cookies object
        */ 
        function cleanCookies(c){
            var obj = {};
            for (var key in c) {
              if (c.hasOwnProperty(key)) {
                obj[key] = c[key].replace(/['"]+/g, '');
              }
            }
            return obj;
        }
        
        /**
        * Grabs all existing cookies
        * @param {void}
        * @return {void}
        */ 
        function getCookieData(){
            var cookies = cookie.all();
            cookies = cleanCookies(cookies);
            return cookies;
        }
        
        /**
        * If a patient ID exists, grab that singular data, otherwise get all active patients and let user pick.
        * @param {object} - cookie object
        * @return {void}
        */ 
        function loadPatientData(cookie_data){
            //Do we have a single user? Or are we wanting all users.
            
            var json = null;
            
            if(cookie_data.hasOwnProperty('PatientID')){
                //single patient
                json = {'PatientID':cookie_data.PatientID,'Action':"getPatientInfo","Token":cookie_data.SessionID};
            }else{
                //all patients
                json = {'Action':"getPatientInfo","Token":cookie_data.SessionID};
            }

            $.post("class.audiogram.php", json)
            .done(function( json ) {
                json = eval("(" + json + ")");
//                console.log('patientinfo:');
//                console.log( json );
                if (typeof json.records == 'object'){
                    $('#patient-name').val(json.records.First+' '+json.records.Last);
                    $('#patient-dob').val(json.records.DOB);
                    $('#facility-name').html(cookie_data.FacilityName);
                    $('#patient-phase').html(cookie_data.PhaseName);
                }else{
                    //Handle multiple patients later
                }
            });
        }
        
        /**
        * Place todays date in the patient data form
        * @param {void}
        * @return {void}
        */        
        function setTodaysDate(){
            var date = new Date();

            var day = date.getDate();
            var month = date.getMonth() + 1;
            var year = date.getFullYear();

            if (month < 10) month = "0" + month;
            if (day < 10) day = "0" + day;

            var today = year + "-" + month + "-" + day;       
            $("#patient-audiogram-date").attr("value", today);
        }
        
        /**
        * Debug helper to load speech and word testing forms with test data
        * @param {void}
        * @return {void}
        */
        function loadSpeechWordData(){
            $('#spch-aud-srt-r').val('45');
            $('#spch-aud-srt-l').val('50');
            $('#spch-aud-srt-b').val('30');
            $('#spch-aud-mask-r').val('30');
            $('#spch-aud-mask-l').val('30');
            $('#spch-aud-mask-b').val('None');
            $('#word-rec-per-r').val('76');
            $('#word-rec-per-l').val('80');
            $('#word-rec-per-b').val('92');
            $('#word-rec-stim-r').val('85');
            $('#word-rec-stim-l').val('90');
            $('#word-rec-stim-b').val('60');
            $('#word-rec-mask-r').val('60');
            $('#word-rec-mask-l').val('65');
            $('#word-rec-mask-b').val('None');
            $('#word-rec-noise-r').val('None');
            $('#word-rec-noise-l').val('None');
            $('#word-rec-noise-b').val('+10');          
        }
        


    </script>      
    </body>
</html>