<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=1413, initial-scale=1">
    
    <!--CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">
    <link href='https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.6.2/css/bootstrap-select.min.css' rel='stylesheet' type='text/css'>
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    
    <link href='http://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Indie+Flower' rel='stylesheet' type='text/css'>
    <link href='http://fonts.googleapis.com/css?family=Play:400,700' rel='stylesheet' type='text/css'>

    
    <!--JavaScript -->
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.6.2/js/bootstrap-select.min.js"></script>
    <script src="js/kinetic.js"></script>
    <script src="js/context.js"></script> 
    <script src="js/contextMenu.js"></script>
    <script src="js/moment.js"></script>
    <script src="js/audiogram.js"></script>

    <!-- https://github.com/js-coder/cookie.js -->
    <script src="js/cookie.min.js"></script>

    <style>
        /* scheme 1 */
        /* turquiose #64D4F9 */
        /* robins egg #15C2D2 */
        /* orange yellow #F7C868 */
        /* light carmine pink #F16767 */
        /* mamba #776A7D */

        /* scheme 2 */
        /*dark cyan #008D8E*/
        /*robins egg blue #15C8D1*/
        /*gray #808281*/
        /*white lilac #E5E7E6*/

        /* tin #7E7E7E */
        /* gray #818181 */
        body{
            color:#3C3F41;
            background-color: #CEE0E9;
            padding-top:10px;
/*            font-family: 'Inconsolata', ;*/
/*            font-family: 'Indie Flower', cursive;*/
            font-family: 'Play', sans-serif;
        }
        
/*        .btn-warning{
            background-image: linear-gradient(to bottom,#f74242 0,#f9a4a4 100%);
        }
*/
        
        h2 {
            color:#414141;
            text-shadow: 2px 2px #808281;
        }
        h3.panel-title{
            font-weight:bold;
        }
        
        hr {
            margin: 10px 10px 0px 10px;
            border: 0;
            border-top: 1px solid #e0e0e0;
        }
        
        .fa-md{
            font-size:1.3em;
            margin-top:3px;
        }
        
        .list-group-wrap{
            margin: 0 auto; 
            text-align: center;
        }
        
        .navbar{
            margin-left:15px;
            margin-right:15px;
        }
        
        .navbar-default .navbar-brand{
            color:#15C2D2;
            font-size:20px;
        }
        
        .navbar-default .navbar-brand.subheading{
            color:#777;
            font-size:14px;
        }
        
        #patient-audiogram-date{
            width:100%
        }
        
        /*Aii styles*/
        
        .aii-btn-border{
            border: 3px solid rgba(0,0,0,.3);
            background-color: #EEEEEE;
        }
        
        .aii-canvas{
            text-align:center;
            margin-top:-20px;
        }
        
        .aii-canvas-menu{
            text-align:center;
        }
        
        .aii-center-column{
            margin: 0 auto; 
            text-align: center;
        }
        
        .aii.control-label{
            font-size:16px;
            font-weight:normal;
            padding-top:5px;
        }
        
        .aii.fa{
            padding-top:3px;
        }
        
        .aii.input-label{
            font-weight:bold;
            padding:5px;
            text-align:right;
        }
                
        .aii.form-control{
            font-weight:bold;
        }
        
        #aii-main-container{
            padding: 0px;
            background-color: #E5E7E6;
            -moz-box-shadow: 0 0 5px 5px rgba(200,200,200,0.5);
            -webkit-box-shadow: 0 0 5px 5px rgba(200,200,200,0.5);
            box-shadow: 0 0 5px 5px rgba(200,200,200,0.5);
            /*padding: 5px 25px 25px 25px;*/
        }
        
        #measure-buttons{
            width:130px;
        }
        
        .aii-mea-btn{
/*            width:130px;*/
            border:3px solid rgba(0,0,0,0);
        }     
        
        .aii-mea-btn.mid{
            margin-left:5px;
            margin-right:5px;
        }
        
        .aii-mea-btn.left{
            font-size:20px;
            font-weight:bold;
            text-align: left;
        }
        
        .aii-mea-btn.right{
            font-size:20px;
            font-weight:bold;
            text-align: right;
        }
        
        #aii-navbar{
            font-size:20px;
        }
        
        .aii.panel.panel-default{
            background:rgba(255,255,255,.5);
        }
        
        .aii.panel.panel-default.patient-info{        
            padding-bottom:10px;
            height:160px;
        }
        
        .aii.panel-heading{
            font-size:20px
        }
        
        .aii.row{
            margin:10px 0px 5px 0px;
/*            padding-left:10px;*/
        }
        
        /*Sawr - styles added to speech audiometry and word recognition */
        .sawr-input{
            width:45px;
            text-align:right;
            padding:3px;
        }
        
        .sawr.panel-heading{
            font-size:16px;
            font-weight:bold;
        }
        
        .sawr-table td,th{
            text-align: center;
        }
        

        
    </style>
    
    </head>
    <body>
        <div class="container" id="aii-main-container">
            <!-- Start Menu bar -->
            <div class="row">
                <nav class="navbar navbar-default navbar-xs" role="navigation">
                    <!-- Brand and toggle get grouped for better mobile display -->
                    <div class="navbar-header">
                        <a class="navbar-brand" href="#"><b>Aii</b> Audiogram</a> 
                        <span class="navbar-brand subheading" id="facility-name">Facility Name</span>
                        <span class="navbar-brand subheading" id="patient-phase">Phase Name</span>
                    </div>
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse pull-right" id="aii-navbar">
                        <ul class="nav navbar-nav">
                            <li class="dropdown">
                                <a href="#" class="dropdown-toggle" data-toggle="dropdown"><b class="caret"></b></a>
                                <ul class="dropdown-menu">
                                    <li><a href="#"><i class="fa fa-plus-square"></i> New Audiogram</a></li>
                                    <li><a href="#"><i class="fa fa-search"></i> Search Audiogram</a></li>
                                    <li><a href="#" class="saveAudiogram"><i class="fa fa-save"></i> Save Audiogram</a></li>
                                    <li><a href="#"><i class="fa fa-print"></i> Print Audiogram</a></li>
                                    <li class="divider"></li>
                                    <li><a href="#" id="toggle-patient-info"><i class="fa fa-caret-square-o-up"></i> Hide Patient Info</a></li>
                                    <li class="divider"></li>
                                    <li><a href="#">One more separated link</a></li>
                                </ul>
                            </li>
                            <li><a href="#" id="newAudiogram"><i class="fa fa-plus-square-o"></i></a></li>
                            <li><a href="#" id="searchAudiogram"><i class="fa fa-search"></i></a></li>
                            <li><a href="#" class="saveAudiogram"><i class="fa fa-save"></i></a></li>
                            <li><a href="#" id="printAudiogram"><i class="fa fa-print"></i></a></li>
                        </ul>
                    </div><!-- /.navbar-collapse -->
                </nav>
            </div>
            <!-- End Menu bar -->
            <!-- Start Patient Info Row -->
            <div class="row" id="patient-info">
                <div class="col-sm-4">
                    <div class="panel panel-default aii patient-info" style="margin-left:15px">
                        <div class="panel-heading aii">
                            <h3 class="panel-title">Patient Info</h3>
                        </div>
                        <div class="row aii">
                            <div class="form-group">
                                <label for="date" class="col-sm-3 control-label">Name:</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="patient-name" place-holder="Patient Name" disabled>
                                </div>
                            </div> 
                        </div>
                        <hr>
                        <div class="row aii">
                            <div class="form-group">
                                <label for="date" class="col-sm-3 control-label">DOB:</label>
                                <div class="col-sm-9">
                                    <input type="text" class="form-control" id="patient-dob" placeholder="DOB" disabled>
                                </div>
                            </div> 
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="panel panel-default aii patient-info">
                        <div class="panel-heading aii">
                            <h3 class="panel-title">Audiogram Title / Date</h3>
                        </div>
                        <div class="row aii">
                            <div class="form-group">
                                <label for="aii-audiogram-title" class="col-sm-2 control-label">Title: </label>
                                <div class="col-sm-8">
                                    <select class="selectpicker show-tick" id="aii-audiogram-title">
                                        <option value="" disabled selected>Choose title...</option>
                                    </select>
                                </div>
                                <div class="col-sm-2"></div>
                            </div>
                        </div>
                            <hr>
                        <div class="row aii">
                            <div class="form-group">
                                <label for="date" class="col-sm-2 control-label">Date:</label>
                                <div class="col-sm-8">
                                    <input type="date" class="form-control aii" id="patient-audiogram-date">
                                </div>
                            </div> 
                        </div>
                    </div>
                </div>
                <div class="col-sm-4">
                    <div class="panel panel-default aii patient-info" style="margin-right:15px">
                        <div class="panel-heading aii">
                            <h3 class="panel-title">Load Audiogram</h3>
                        </div>
                            <div class="row aii">
                                <div class="form-group">
                                    <div class="col-sm-8">
                                        <select class="selectpicker show-tick" id="aii-audiogram-prev" name="loaded_audiogram_title">
                                            <option value="" disabled selected>Choose Audiogram...</option>
                                        </select>
                                    </div>
                                    <div class="col-sm-4">
                                        <button class="btn btn-default" type="button" id="load-audiogram"><i class="fa fa-headphones fa-md"></i> Load </button>
                                    </div>
                                </div>
                            </div>
                            <hr>
                            <div class="row aii">
                                <div class="form-group">
                                    <div class="col-sm-3"></div>
                                     <div class="col-sm-4">
                                        <div class="input-group">
                                          <span class="input-group-btn">
                                            <button class="btn btn-default" type="button" id="load-latest"><i class="fa fa-headphones fa-md"></i> Load Latest</button>
                                          </span>
                                        </div><!-- /input-group -->
 
                                      </div><!-- /.col-lg-6 -->
                                    <div class="col-sm-5"></div>                                   
                                    
                                </div>
                            </div>  
                    </div>
                 </div>
            </div>
            <!-- End Patient Info Row -->

            <!-- Start Ear Condition Row -->
            <div class="container" id="aii-controls-container">
                <div class="row">
                    <!-- Begin Right Column -->
                    <div class="col-sm-5">
                            <div class="panel panel-default aii">
                              <div class="panel-heading sawr">
                                <h3 class="panel-title">Right Ear</h3>
                              </div>
                              <div class="panel-body">
                                <div class="row">
                                    <div class="form-group">
                                        <label for="status" class="col-sm-3 control-label aii">Condition: </label>
                                        <div class="col-sm-7">
                                            <select class="selectpicker show-tick" id="right-condition-opts">
                                                <option value="" disabled selected>Choose ear condition...</option>
                                            </select>
                                        </div>
                                        <div class="col-sm-2"></div>
                                    </div>
                                </div>
                                <!-- Begin Right Canvas -->
                                <div class="row">   
                                    <div class="aii-canvas"  id="left_column">
                                        <div class="audiogram-container" id="audiogram_right"></div>
                                    </div>
                                </div>              
                                <!-- End Right Canvas -->
                                <!-- Begin Menu Row -->
                                <div class="row">
                                    <div class="aii-canvas-menu" data="right">
                                        <button class="btn btn-default btn-xs" data="Undo" id="undo"><i class="fa fa-undo pull-left aii"></i>Undo</button>
                                        <button class="btn btn-default btn-xs" data="Refresh" id="refresh"><i class="fa fa-refresh pull-left aii"></i>Clear</button>
                                        <button class="btn btn-default btn-xs" data="Redo" id="redo"><i class="fa fa-repeat pull-left aii"></i>Redo</button>
                                    </div>
                                </div> 
                            </div>
                        </div>
                    </div>
                    <!-- End Right Column -->
                    <!-- Begin Middle Column -->
                    <div class="col-sm-2" id="aii-center-column">
                        <!-- Auditory measure buttons -->
                        <div class="list-group-wrap">
                            <div class="panel panel-default aii">
                              <div class="panel-heading">
                                <h3 class="panel-title">Measures</h3>
                              </div>
                              <div class="panel-body">
                                    <div class="list-group" id="measure-buttons">
                                        <a href="#" class="list-group-item aii-mea-btn aii-btn-border" id="AC">
                                            <span class="aii-mea-btn left" id="ACR"><i class="fa fa-circle-o"></i>&nbsp;&nbsp;</span><span class="aii-mea-btn mid">AC</span>&nbsp;&nbsp;<span class="aii-mea-btn right" id="ACL">&#10005;</span>
                                        </a>
                                        <a href="#" class="list-group-item aii-mea-btn" id="BC">
                                            <span class="aii-mea-btn left" id="BCR">&nbsp;&nbsp;<i class="fa fa-chevron-left"></i></span><span class="aii-mea-btn mid">BC</span>&nbsp;&nbsp;<span class="aii-mea-btn right" id="BCL"><i class="fa fa-chevron-right"></i></span>
                                        </a>
                                        <a href="#" class="list-group-item aii-mea-btn" id="MCL">
                                            <span class="aii-mea-btn left">M</span>&nbsp;&nbsp;<span class="aii-mea-btn mid">MCL</span>&nbsp;&nbsp;<span class="aii-mea-btn right">M</span>
                                        </a>
                                        <a href="#" class="list-group-item aii-mea-btn" id="UCL">
                                            <span class="aii-mea-btn left">m</span>&nbsp;&nbsp;<span class="aii-mea-btn mid">UCL</span>&nbsp;&nbsp;<span class="aii-mea-btn right">m</span>
                                        </a>
                                        <a href="#" class="list-group-item aii-mea-btn" id="SF">
                                            <span class="aii-mea-btn left">S</span>&nbsp;&nbsp;&nbsp;<span class="aii-mea-btn mid">SF</span>&nbsp;&nbsp;&nbsp;<span class="aii-mea-btn right">S</span>
                                        </a>
                                        <a href="#" class="list-group-item aii-mea-btn" id="SF-A">
                                            <span class="aii-mea-btn left">A</span>&nbsp;<span class="aii-mea-btn mid">SF-A</span>&nbsp;<span class="aii-mea-btn right">A</span>
                                        </a>
                                    </div> 
                                    <div>
                                        <span class="button-checkbox">
                                            <button type="button" class="btn" id="mask-tool"> Masked</button>
                                            <input type="checkbox" class="hidden" />
                                        </span>
                                    </div>
                              </div>
                            </div>

                        </div>
                    </div>
                    <!-- End Middle Column -->
                    <!-- Begin Left Column -->
                    <div class="col-sm-5">
                            <div class="panel panel-default aii">
                              <div class="panel-heading">
                                <h3 class="panel-title">Left Ear</h3>
                              </div>
                              <div class="panel-body">
                                <div class="row">
                                    <div class="form-group">
                                        <label for="status" class="col-sm-3 control-label aii">Condition: </label>
                                        <div class="col-sm-7">
                                            <select class="selectpicker show-tick" id="left-condition-opts">
                                                <option value="" disabled selected>Choose ear condition...</option>
                                            </select>
                                        </div>
                                        <div class="col-sm-2"></div>
                                    </div>
                                </div>
                                <!-- Begin Right Canvas -->
                                <div class="row">   
                                    <div class="aii-canvas"  id="right_column">
                                        <div class="audiogram-container" id="audiogram_left"></div>
                                    </div>
                                </div>              
                                <!-- End Right Canvas -->
                                <!-- Begin Menu Row -->
                                <div class="row">
                                    <div class="aii-canvas-menu" data="left">
                                        <button class="btn btn-default btn-xs" data="Undo" id="undo"><i class="fa fa-undo pull-left aii"></i>Undo</button>
                                        <button class="btn btn-default btn-xs" data="Refresh" id="refresh"><i class="fa fa-refresh pull-left aii"></i>Clear</button>
                                        <button class="btn btn-default btn-xs" data="Redo" id="redo"><i class="fa fa-repeat pull-left aii"></i>Redo</button>
                                    </div>
                                </div> 
                            </div>
                        </div>
                    </div>
                    <!-- End Left Column -->
                </div>
            </div>
            <!-- End Ear Condition Row -->
            <div class="row">
                <div class="col-xs-2 aii-center-menu">

                </div>
                <!-- End Button Column-->
            </div> 
            <!-- End Row -->
            <div class="row">
                <div class="col-xs-1"></div>
                <div class="col-xs-5">
                    <div class="panel panel-default aii">
                        <!-- Default panel contents -->
                        <div class="panel-heading sawr">
                            <h3 class="panel-title">Speech Audiometry:</h3>
                        </div>
                        <!-- Table -->
                        <table class="table table-condensed sawr-table">
                            <tr style="text-align:center"><th></th><th>SRT</th><th>Mask</th><th></th></tr>
                            <tr><td style="text-align:right">R</td><td><input type="text" class="sawr-input" id="spch_aud_srt_r"></td><td><input type="text" class="sawr-input" id="spch_aud_mask_r"></td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
                            <tr><td style="text-align:right">L</td><td><input type="text" class="sawr-input" id="spch_aud_srt_l"></td><td><input type="text" class="sawr-input" id="spch_aud_mask_l"></td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
                            <tr><td style="text-align:right">Binaural</td><td><input type="text" class="sawr-input" id="spch_aud_srt_b"></td><td><input type="text" class="sawr-input" id="spch_aud_mask_b"></td><td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</td></tr>
                        </table>
                    </div>
                </div>
                <div class="col-xs-5">
                    <div class="panel panel-default aii">
                        <!-- Default panel contents -->
                        <div class="panel-heading sawr">
                            <h3 class="panel-title">Word Recognition:</h3>
                        </div>
                        <!-- Table -->
                        <table class="table table-condensed sawr-table">
                            <tr style="text-align:center"><th></th><th>%</th><th>Stimulus</th><th>Mask</th><th>Noise</th></tr>
                            <tr><td style="text-align:right">R</td><td><input type="text" class="sawr-input" id="word_rec_per_r"></td><td><input type="text" class="sawr-input" id="word_rec_stim_r"></td><td><input type="text" class="sawr-input" id="word_rec_mask_r"></td><td><input type="text" class="sawr-input" id="word_rec_noise_r"></td></tr>
                            <tr><td style="text-align:right">L</td><td><input type="text" class="sawr-input" id="word_rec_per_l"></td><td><input type="text" class="sawr-input" id="word_rec_stim_l"></td><td><input type="text" class="sawr-input" id="word_rec_mask_l"></td><td><input type="text" class="sawr-input" id="word_rec_noise_l"></td></tr>
                            <tr><td style="text-align:right">Binaural</td><td><input type="text" class="sawr-input" id="word_rec_per_b"></td><td><input type="text" class="sawr-input" id="word_rec_stim_b"></td><td><input type="text" class="sawr-input" id="word_rec_mask_b"></td><td><input type="text" class="sawr-input" id="word_rec_noise_b"></td></tr>
                        </table>
                    </div>
                </div>
                <div class="col-xs-1"></div>
            </div>
            <div class="row">
               <div class="col-xs-10"></div><div class="col-xs-2"><a class="btn btn-default saveAudiogram" href="#" role="button"><i class="fa fa-save"></i> Save</a></div>
            </div>
        </div> <!-- End Container --> 
    <script>
        
        $(function() {
            //combine stuff later
            $( "a" ).click(function( event ) {
              event.preventDefault();
            });
            
            var stage_right = new Kinetic.Stage({
                container: 'audiogram_right',
                width: 450,
                height: 450
            });

            var stage_left = new Kinetic.Stage({
                container: 'audiogram_left',
                width: 450,
                height: 450
            });

            var Stage = {};
            var cookieData = null;
            var conditionChoices = null;
            
            //create both canvas' and add 'right-click' event handlers to each canvas
            //should be handled in audiogram.js
            //setTimeout(function(){
            Stage['right'] = new AudioGram(stage_right,100,'right','audiogram_right');
            Stage['left'] = new AudioGram(stage_left,200,'left','audiogram_left');
            Stage['right'].bindContextMenu();
            Stage['left'].bindContextMenu();  
            Stage['right'].bindKeyPress();
            Stage['left'].bindKeyPress();


            $( ".aii-mea-btn" ).on( "click", function(e) {
                var clicked = $( this )[0].id;
                setTimeout( function (){
                    $( ".aii-mea-btn" ).each(function( index ) {
                        if($( this )[0].id != 'mask-button'){
                            if(clicked == $( this )[0].id){
                                $( this ).addClass('aii-btn-border');
                                $( this ).blur();
                            }else{
                                $( this ).removeClass('aii-btn-border');
                            }
                        }
                    })
                    setTimeout( function (){
                        $( ".aii-mea-btn" ).each(function( index ) {
                            if($( this ).hasClass( "aii-btn-border" )){
                                Stage['right'].setMeasureType(clicked);
                                Stage['left'].setMeasureType(clicked);
                            }
                        });
                    }, 0 );
                }, 0 );
                e.preventDefault();
            });

            $('.aii-canvas-menu').on('click', function(event) {
                var side = $( this ).attr('data');
                var action = $(event.target).closest('button').attr("data");
                var current = null;

                switch(action){
                    case 'Refresh': Stage[side].clear();
                        break;
                    case 'Undo':    Stage[side].undo();
                        break;
                    case 'Redo':    Stage[side].redo();
                        break;
                }
                $(event.target).closest('button').blur();
                event.preventDefault();
            });
            
            $('#printAudiogram').on('click', function(event) {
                var canvas_right = $("#audiogram_right").find(".kineticjs-content").children();
                var canvas_left = $("#audiogram_left").find(".kineticjs-content").children();
                var ImgData = {
                    "action" : "print",
                    "background" : canvas_right[0].toDataURL("image/png"),
                    "right" : {
                        "line" : canvas_right[1].toDataURL("image/png"),
                        "measures" : canvas_right[2].toDataURL("image/png")
                    },
                    "left" : {
                        "line" : canvas_left[1].toDataURL("image/png"),
                        "measures" : canvas_left[2].toDataURL("image/png")
                    }
                }
            
                console.log(ImgData);

                $.post( "class.audiogram.php", ImgData)
                .done(function( data ) {
                    console.log( "Data Loaded: " + data );
                });
                event.preventDefault();
            });
            
            $('.saveAudiogram').on('click', function(event) {
                
                event.preventDefault();
                var errors = 0;
                var audiogram_id = 0;
                
                //Check for mandatory fields on audiogram page
                errors += checkSaveError($('#aii-audiogram-title'),'Title Needed...');
                errors += checkSaveError($('#right-condition-opts'),'Condition Needed...');
                errors += checkSaveError($('#left-condition-opts'),'Condition Needed...');
                
                //If errors, then quit (handle later)
                if(errors > 0){
                    console.log("error on save");
                    return;
                }
                
                //Create the save function which builds the json package for the ajax request
                var saveAudiogramData = function(id){
                    console.log(id);
                    var AudiogramData = {
                            "date" : unixTime(),                
                            "title" : $('#aii-audiogram-title option:selected').val(),
                            "audiogram_id": id,
                            "event_id": "1018",
                            "phase_id": "7",
                            "patient_id": "1018",
                            "spch_aud_srt_r":$('#spch_aud_srt_r').val(),
                            "spch_aud_srt_l":$('#spch_aud_srt_l').val(),
                            "spch_aud_srt_b":$('#spch_aud_srt_b').val(),
                            "spch_aud_mask_r":$('#spch_aud_mask_r').val(),
                            "spch_aud_mask_l":$('#spch_aud_mask_l').val(),
                            "spch_aud_mask_b":$('#spch_aud_mask_b').val(),
                            "word_rec_per_r":$('#word_rec_per_r').val(),
                            "word_rec_per_l":$('#word_rec_per_l').val(),
                            "word_rec_per_b":$('#word_rec_per_b').val(),
                            "word_rec_stim_r":$('#word_rec_stim_r').val(),
                            "word_rec_stim_l":$('#word_rec_stim_l').val(),
                            "word_rec_stim_b":$('#word_rec_stim_b').val(),
                            "word_rec_mask_r":$('#word_rec_mask_r').val(),
                            "word_rec_mask_l":$('#word_rec_mask_l').val(),
                            "word_rec_mask_b":$('#word_rec_mask_b').val(),
                            "word_rec_noise_r":$('#word_rec_noise_r').val(),
                            "word_rec_noise_l":$('#word_rec_noise_l').val(),
                            "word_rec_noise_b":$('#word_rec_noise_b').val(),
                            "left_condition": $('#left-condition-opts option:selected').val(),
                            "right_condition":$('#right-condition-opts option:selected').val(),
                            "left_measures": Stage['left'].getAudiogramRawMeasures(),
                            "right_measures": Stage['right'].getAudiogramRawMeasures()                       
                    };

                    //"left_measures": Stage['left'].getAudiogramMeasures(),
                    //"right_measures": Stage['right'].getAudiogramMeasures(),
                    
                    //Perform ajax save
                    var tmp = JSON.stringify(AudiogramData);
                    console.log(tmp);
                    $.ajax({
                        type: 'POST',
                        url: "http://aii-hermes.org/aii-api/v1/audiograms",
                        data: tmp,
                        contentType: "application/json; charset=utf-8",
                        success: function(tmp) {
                            console.log(tmp);
                        }
                    });
                }
                
                //Create a function to get the max audiogram_id, then pass in the
                //saveAudiogramData as a callback function so we get the max_id 
                //before we try to save the audiogram. 
                //Maybe should get the max id on the back end? Probably.
                var getMaxAudiogramId = function(callback){
                    $.get("http://aii-hermes.org/aii-api/v1/audiograms/getLatestAudiogramID")
                    .done(function( data ) {
                        var id = parseInt(data.records) + 1;
                        if(typeof callback === "function") callback(id);
                    });
                }
                
                setTimeout( function (){
                    
                    getMaxAudiogramId(saveAudiogramData);
                    
                    setTimeout( function (){
                        init(); 
                    }, 0 );
                }, 0 );
                             
            });
            
            $('#searchAudiogram').on('click', function(event) {
                $.post("class.audiogram.php", searchData)
                .done(function( data ) {
                    console.log( "Data Loaded: " + data );
                });
                event.preventDefault();
            });
            
        
            //Added for checkbox buttons
            $('.button-checkbox').each(function () {

                // Settings
                var $widget = $(this),
                    $button = $widget.find('button'),
                    $checkbox = $widget.find('input:checkbox'),
                    color = $button.data('color'),
                    settings = {
                        on: {
                            icon: 'fa fa-check-square-o'
                        },
                        off: {
                            icon: 'fa fa-ban'
                        }
                    };

                // Event Handlers
                $button.on('click', function () {
                    $checkbox.prop('checked', !$checkbox.is(':checked'));
                    $checkbox.triggerHandler('change');
                    updateConditionButtons();
                    event.preventDefault();
                });
                
                $checkbox.on('change', function () {
                    updateConditionButtons();
                });
                
            });

            
            $('#toggle-patient-info').on('click', function () {
                if($('#patient-info').hasClass('hidden')){
                    $( "#patient-info" ).slideDown( "slow", function() {
                        $('#toggle-patient-info').html('<i class="fa fa-caret-square-o-up"></i> Hide Patient Info');
                        $('#patient-info').removeClass('hidden');
                    });
                }else{
                    $( "#patient-info" ).slideUp( "slow", function() {
                        $('#toggle-patient-info').html('<i class="fa fa-caret-square-o-down"></i> Show Patient Info');
                        $('#patient-info').addClass('hidden');
                    });
                }
                event.preventDefault();
            });

            $('#show-patient-info').on('click', function () {
                $('#patient-info').css('display','block');
                $('#hide-patient-info').css('display','block');
                $('#show-patient-info').css('display','none');
                event.preventDefault();
            });
            
            //Load a previously saved audiogram
            //Putting it back in the same state with title, and ear conditions.
            $('#load-audiogram').on('click', function (event) {
                Stage['right'].clear();
                Stage['left'].clear();
                
                console.log($('#load-latest').is( ":focus" ));
                
                var audiogram_id = $('#aii-audiogram-prev option:selected').val();
                if(audiogram_id == ''){
                    console.log("error");
                    return;
                }
                
                $.get("http://aii-hermes.org/aii-api/v1/audiograms/"+audiogram_id)
                .done(function( data ) {
                    console.log("Loading:");

                    
                    var data = data.records;
                    
                    console.log(data);
                    
                    var right_json = JSON.parse(data.right_measures);
                    var left_json = JSON.parse(data.right_measures);
                    
                    //Load measures on each canvas
                    Stage['right'].loadAudiogram(right_json);
                    Stage['left'].loadAudiogram(left_json);
                    
                    //Update audiogram title
                    $('#aii-audiogram-title').val(data.title);
                    $('#aii-audiogram-title').selectpicker('refresh');
                    
                    $("#patient-audiogram-date").attr("value", fromUnixTime(data.date));
                    
                    //Update left and right ear conditions
                    $('#right-condition-opts').val(data.right_condition);
                    $('#right-condition-opts').selectpicker('refresh');
                    $('#left-condition-opts').val(data.left_condition);
                    $('#left-condition-opts').selectpicker('refresh');
                    
                    
                    
                    $('#spch_aud_srt_r').val(data.spch_aud_srt_r);
                    $('#spch_aud_srt_l').val(data.spch_aud_srt_l);
                    $('#spch_aud_srt_b').val(data.spch_aud_srt_b);
                    $('#spch_aud_mask_r').val(data.spch_aud_mask_r);
                    $('#spch_aud_mask_l').val(data.spch_aud_mask_l);
                    $('#spch_aud_mask_b').val(data.spch_aud_mask_b);
                    $('#word_rec_per_r').val(data.word_rec_per_r);
                    $('#word_rec_per_l').val(data.word_rec_per_l);
                    $('#word_rec_per_b').val(data.word_rec_per_b);
                    $('#word_rec_stim_r').val(data.word_rec_stim_r);
                    $('#word_rec_stim_l').val(data.word_rec_stim_l);
                    $('#word_rec_stim_b').val(data.word_rec_stim_b);
                    $('#word_rec_mask_r').val(data.word_rec_mask_r);
                    $('#word_rec_mask_l').val(data.word_rec_mask_l);
                    $('#word_rec_mask_b').val(data.word_rec_mask_b);
                    $('#word_rec_noise_r').val(data.word_rec_noise_r);
                    $('#word_rec_noise_l').val(data.word_rec_noise_l);
                    $('#word_rec_noise_b').val(data.word_rec_noise_b);
                    
                });
                event.preventDefault();
            });
                        

            $('#load-latest').on('click', function (event) {
                $('#aii-audiogram-prev option:last-child').attr('selected', 'selected');
                $('#load-audiogram').trigger( "click" );
            });
            
            function checkSaveError(ele,message){
                
                var $ele = ele
                var title = $ele.val();
                var error = 0;
                                
                if(title == "" || title == null){
                    error = 1;
                    $ele.selectpicker('setStyle', 'btn-danger', 'add');
                }
                
                $ele.on('change',function(){
                    $ele.selectpicker('setStyle', 'btn-danger', 'remove').selectpicker('refresh');;                  
                });
                
                return error;
            }
            

            
            function updateConditionButtons() {
                // Settings
                var $widget = $('.button-checkbox'),
                    $button = $widget.find('button'),
                    $checkbox = $widget.find('input:checkbox'),
                    color = $button.data('color'),
                    isChecked = $checkbox.is(':checked'),
                    settings = {
                        on: {
                            icon: 'fa fa-check-square-o'
                        },
                        off: {
                            icon: 'fa fa-ban'
                        }
                    };

                // Set the button's state
                $button.data('state', (isChecked) ? "on" : "off");

                // Set the button's icon
                $button.find('.state-icon')
                .removeClass()
                .addClass('state-icon ' + settings[$button.data('state')].icon);

                // Update the button's color
                if (isChecked) {
                    $button
                    .removeClass('btn-default')
                    .addClass('btn-' + color + ' active')
                    .blur();
                    Stage['right'].setMasked(1);
                    Stage['left'].setMasked(1);
                    $('#BCL').html('&nbsp;&nbsp;]');
                    $('#BCR').html('[&nbsp;&nbsp;');        
                    $('#ACL').html('<i class="fa fa-square-o"></i>');
                    $('#ACR').html('&#x25b3;');
                } else {
                    $button
                    .removeClass('btn-' + color + ' active')
                    .addClass('btn-default')
                    .blur();
                    Stage['right'].setMasked(0);
                    Stage['left'].setMasked(0);  
                    $('#BCR').html('<i class="fa fa-chevron-left"></i>&nbsp;');
                    $('#BCL').html('&nbsp;<i class="fa fa-chevron-right"></i>');
                    $('#ACR').html('<i class="fa fa-circle-o"></i>');
                    $('#ACL').html('&#10005;');
                }
            }
            
            // Initialization
            function init() {
                setTimeout( function (){
                    //Gets cookies from current session
                    cookieData = getCookieData();
                    
                    console.log('cookie:');
                    console.log(cookieData);

                    //If the cookie timed out, redirect home
                    if(cookieData['BadToken'] == 'Token Timeout'){
                        window.location.href = '/cochlearProject/';
                    }

                    //Put condition buttons in the proper state
                    updateConditionButtons();

                    setTimeout( function (){
                        
                        populateConditionChoices();
                        populateTitleChoices();
                        populatePrevAudiograms();
                        loadPatientData(cookieData);
                        
                        var $button = $('.button-checkbox').find('button');
                        var settings = {
                            on: {
                                icon: 'fa fa-check-square-o'
                            },
                            off: {
                                icon: 'fa fa-ban'
                            }
                        };
                        // Inject the icon if applicable next to the masked button.
                        if ($button.find('.state-icon').length == 0) {
                            $button.prepend('<i class="state-icon '+settings[$button.data('state')].icon + '"></i>');
                        }
                    }, 0 );
                }, 0 );
                Stage['right'].clear();
                Stage['left'].clear(); 
            }
            
            init();

            setTodaysDate();
            
            //testing only
            loadSpeechWordData();
            
            //Library for bootstrap dropdowns.
            $('.selectpicker').selectpicker();
            
        });
        
        /**
        * Re-sets the page back to its original "state" of cleanliness.
        * @param {void}
        * @return {void}
        */ 
        function resetPage(){
            $('#aii-audiogram-title option:first').attr('selected','selected');
            //$("#target option:first").attr('selected','selected');
        }

        /**
        * Gets the unique condition choices for each ear (cochlear, unaided, etc.)
        * @param {void}
        * @return {void}
        */ 
        function populateConditionChoices(){
        
            $.get("http://aii-hermes.org/aii-api/v1/audioConditions")
            .done(function( json ){
                var temp = [], conditions = [], l = json.records.length, i;
                for( i=0; i<l; i++) {
                    if( temp[json.records[i].LeftAidCondition]) continue;
                    temp[json.records[i].LeftAidCondition] = true;
                    conditions.push(json.records[i].LeftAidCondition);
                }
                
                var Html = '<option value="" disabled selected>Choose ear condition...</option>';
                
                for(var i=0;i<conditions.length;i++){
                    Html = Html + '<option value="'+conditions[i]+'">'+conditions[i]+'</option>';
                }
                
                $('#right-condition-opts').html(Html).selectpicker('refresh');
                $('#left-condition-opts').html(Html).selectpicker('refresh');
            });
        }    
        
        /**
        * Gets the titles available for audiograms
        * @param {void}
        * @return {void}
        */ 
        function populateTitleChoices(){
            
            $.get("http://aii-hermes.org/aii-api/v1/audioTitles")
            .done(function( json ){
                var temp = [], conditions = [], l = json.records.length, i;
                for( i=0; i<l; i++) {
                    if( temp[json.records[i].Title]) continue;
                    temp[json.records[i].Title] = true;
                    conditions.push(json.records[i].Title);
                }
                
                var Html = '<option value="" disabled selected>Choose Title...</option>';
                
                for(var i=0;i<conditions.length;i++){
                    Html = Html + '<option value="'+conditions[i]+'">'+conditions[i]+'</option>';
                }
                
                $('#aii-audiogram-title').html(Html).selectpicker('refresh');
            });
        }
        
        /**
        * Gets a list of previous audiograms ... if any
        * @param {void}
        * @return {void}
        */ 
        function populatePrevAudiograms(){

            var audiogram_date = null;
            
            $.get("http://aii-hermes.org/aii-api/v1/audiograms&fields=(audiogram_id,date,title)")
            .done(function( json ){
                if(json.records.length>0){
                    var Html = '<option value="" disabled selected>Find Previous Audiogram <i class="fa fa-search"></i></option>';
                    for( i=0; i<json.records.length; i++) {
                        console.log(json.records[i].date);
                        audiogram_date = moment.unix(json.records[i].date).format("MM/DD/YY");
                        Html = Html + '<option value="'+json.records[i].audiogram_id+'">'+audiogram_date+' - '+json.records[i].title+'</option>';
                    }
                }else{
                    var Html = '<option value="" disabled selected>NO Previous Audiograms </option>';                    
                }
                
                $('#aii-audiogram-prev').html(Html).selectpicker('refresh');
            });
        }        
        
        /**
        * Trims extra double quotes and single quotes off of strings. I used a locally created
        * object because of some funny behavior I couldnt track down quickly.
        * @param {void}
        * @return {object} cookies object
        */ 
        function cleanCookies(c){
            var obj = {};
            for (var key in c) {
              if (c.hasOwnProperty(key)) {
                obj[key] = c[key].replace(/['"]+/g, '');
              }
            }
            return obj;
        }
        
        /**
        * Grabs all existing cookies
        * @param {void}
        * @return {void}
        */ 
        function getCookieData(){
            var cookies = cookie.all();
            cookies = cleanCookies(cookies);
            return cookies;
        }
        
        /**
        * If a patient ID exists, grab that singular data, otherwise get all active patients and let user pick.
        * @param {object} - cookie object
        * @return {void}
        */ 
        function loadPatientData(cookie_data){
            //Do we have a single user? Or are we wanting all users.
            
            var json = null;
            
            if(cookie_data.hasOwnProperty('PatientID')){
                //single patient
                json = {'PatientID':cookie_data.PatientID,'Action':"getPatientInfo","Token":cookie_data.SessionID};
            }else{
                //all patients
                json = {'Action':"getPatientInfo","Token":cookie_data.SessionID};
            }

            $.post("class.audiogram.php", json)
            .done(function( json ) {
                json = eval("(" + json + ")");
//                console.log('patientinfo:');
//                console.log( json );
                if (typeof json.records == 'object'){
                    $('#patient-name').val(json.records.First+' '+json.records.Last);
                    $('#patient-dob').val(json.records.DOB);
                    $('#facility-name').html(cookie_data.FacilityName);
                    $('#patient-phase').html(cookie_data.PhaseName);
                }else{
                    //Handle multiple patients later
                }
            });
        }
        
        /**
        * Place todays date in the patient data form
        * @param {void}
        * @return {void}
        */        
        function setTodaysDate(){
            var date = new Date();

            var day = date.getDate();
            var month = date.getMonth() + 1;
            var year = date.getFullYear();

            if (month < 10) month = "0" + month;
            if (day < 10) day = "0" + day;

            var today = year + "-" + month + "-" + day;       
            $("#patient-audiogram-date").attr("value", today);
        }
        
        /**
        * Debug helper to load speech and word testing forms with test data
        * @param {void}
        * @return {void}
        */
        function loadSpeechWordData(){
            $('#spch_aud_srt_r').val('45');
            $('#spch_aud_srt_l').val('50');
            $('#spch_aud_srt_b').val('30');
            $('#spch_aud_mask_r').val('30');
            $('#spch_aud_mask_l').val('30');
            $('#spch_aud_mask_b').val('None');
            $('#word_rec_per_r').val('76');
            $('#word_rec_per_l').val('80');
            $('#word_rec_per_b').val('92');
            $('#word_rec_stim_r').val('85');
            $('#word_rec_stim_l').val('90');
            $('#word_rec_stim_b').val('60');
            $('#word_rec_mask_r').val('60');
            $('#word_rec_mask_l').val('65');
            $('#word_rec_mask_b').val('None');
            $('#word_rec_noise_r').val('None');
            $('#word_rec_noise_l').val('None');
            $('#word_rec_noise_b').val('+10');          
        }
        
        function unixTime(){
            var time = 0;
            if (!Date.now) {
                time =  new Date().getTime() / 1000;
            }else{
                time = Date.now() / 1000;
            }
            
            return Math.floor(time);
        }
        
        function fromUnixTime(UNIX_timestamp){
            var a = new Date(UNIX_timestamp*1000);

            var year = a.getFullYear();

            var month = a.getMonth() + 1;
            if (month < 10) month = "0" + month;
            
            var day = a.getDate();
            if (day < 10) day = "0" + day;
            
            return  year + "-" + month + "-" + day;  
        }

    </script>      
    </body>
</html>